{"version":3,"sources":["../src/course_image_uploader.js"],"names":["define","$","ajax","notification","str","ModalFactory","ModalEvents","_root","_maxbytes","_courseid","_imagedata","_imagename","SELECTORS","UPLOADER","HEADER","HEADER_TOP","SQUARE_IMG","STYLE_HDR","UPLOAD_BTN","CANCEL_BTN","_setGlobals","root","maxbytes","courseid","_setImageData","imagedata","_setImageName","imagename","_registerEventListeners","on","_handleImageChange","_uploadImage","_cancelUpload","event","target","files","length","file","type","match","get_string","done","_createErrorPopup","size","_humanFileSize","name","reader","FileReader","onload","_confirmImageUpload","readAsDataURL","result","styleselect","data","css","addClass","split","args","ajaxCall","methodname","_uploadDone","fail","exception","call","removeClass","val","_createSuccessPopup","original_img","text","popup","dismissBtn","html","attr","append","prop","setTimeout","fadeTo","slideUp","remove","i","Math","floor","log","pow","toFixed","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Theme Boost Campus - Code for course header image uploader.\n *\n * @package    theme_urcourses_default\n * @author     John Lane\n *\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str', 'core/modal_factory',\n    'core/modal_events'], function($, ajax, notification, str, ModalFactory, ModalEvents) {\n\n    /** Container jquery object. */\n    var _root;\n    /** Maximum file size. */\n    var _maxbytes;\n    /** Course ID */\n    var _courseid;\n    /** Image data for course image to be uploaded. */\n    var _imagedata;\n    /** Name of image. */\n    var _imagename;\n\n    /** Jquery selector strings. */\n    var SELECTORS = {\n        UPLOADER: '#course_image_uploader',\n        HEADER: '#page-header .header-body',\n        HEADER_TOP: '#page-header .page-head',\n        SQUARE_IMG: '#hdr_chooser_a_div',\n        STYLE_HDR: '#header_a_head',\n        UPLOAD_BTN: '#upload_img_confirm',\n        CANCEL_BTN: '#upload_img_cancel',\n    };\n\n    /**\n     * Initializes global variables.\n     * @param {string} root - Jquery selector for container.\n     * @param {int} maxbytes - Maximum allowed file size.\n     * @param {int} courseid - ID of current course.\n     * @return void\n     */\n    var _setGlobals = function(root, maxbytes, courseid) {\n       _root = $(root);\n       _maxbytes = maxbytes;\n       _courseid = courseid;\n    };\n\n    /**\n     * Initializes _imagedata.\n     * @param {string} imagedata\n     */\n    var _setImageData = function(imagedata) {\n        _imagedata = imagedata;\n    };\n\n    /**\n     * Initializes _imagename.\n     * @param {string} imagename\n     */\n    var _setImageName = function(imagename) {\n        _imagename = imagename;\n    };\n\n    /**\n     * Sets up event listeners.\n     * @return void\n     */\n    var _registerEventListeners = function() {\n        _root.on('change', SELECTORS.UPLOADER, _handleImageChange);\n        _root.on('click', SELECTORS.UPLOAD_BTN, _uploadImage);\n        _root.on('click', SELECTORS.CANCEL_BTN, _cancelUpload);\n    };\n\n    var _handleImageModal = function() {\n        //adding in confirmation modal in case buttons accidentally clicked\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: 'Change Course Image',\n            body: 'Some body content here'\n        })\n        .then(function(modal) {\n            modal.setSaveButtonText('Change');\n            var root = modal.getRoot();\n            root.on(ModalEvents.cancel, function(){\n                return;\n            });\n            root.on(ModalEvents.save, _handleImageChange);\n            modal.show();\n        });\n    };\n\n    /**\n     * Sets course image to uploaded file.\n     * Mostly lifted from theme_snap.\n     * @param {Object} event\n     * @return void\n     */\n    var _handleImageChange = function(event) {\n\n        // if no file was uploaded, return\n        if (!event.target.files.length) {\n            return;\n        }\n\n        // get the file\n        var file = event.target.files[0];\n\n        // if file was not an image, return\n        if (!file.type.match('image.*')) {\n            str.get_string('error:courseimageinvalidfiletype', 'theme_urcourses_default')\n                .done(_createErrorPopup);\n\n            return;\n        }\n\n        // if the file is too big, return\n        if (file.size > _maxbytes) {\n            str.get_string('error:courseimageexceedsmaxbytes', 'theme_urcourses_default', _humanFileSize(_maxbytes))\n                .done(_createErrorPopup);\n\n            return;\n        }\n\n        // set _imagename\n        _setImageName(file.name);\n\n        var reader = new FileReader();\n        reader.onload = _confirmImageUpload;\n        reader.readAsDataURL(file);\n    };\n\n    /**\n     * Prompts user to confirm image upload.\n     * @param {Object} event\n     */\n    var _confirmImageUpload = function(file) {\n        var imagedata = file.target.result;\n\n        var styleselect = ($(SELECTORS.STYLE_HDR).length>0) ? SELECTORS.SQUARE_IMG : SELECTORS.HEADER;\n\n        // store original image in DOM node\n        $(styleselect).data('original_img', $(styleselect).css('background-image'));\n\n        // set background image to temp file\n        $(SELECTORS.SQUARE_IMG).css({'background-image': 'url(' + imagedata + ')'});\n        $(SELECTORS.HEADER).css({'background-image': 'url(' + imagedata + ')'});\n\n        // show confirm/cancel buttons\n        _root.addClass('confirm');\n\n        // init _imagedata\n        imagedata = imagedata.split('base64,')[1];\n        _setImageData(imagedata);\n    };\n\n    /**\n     * Initiate ajax call to upload and set new image.\n     */\n    var _uploadImage = function() {\n        // return if required values aren't set\n        if (!_imagedata || !_imagename || !_courseid) {\n            return;\n        }\n\n        // set args\n        var args = {\n            courseid: _courseid,\n            imagedata: _imagedata,\n            imagename: _imagename,\n        };\n\n        // set ajax call\n        var ajaxCall = {\n            methodname: 'theme_urcourses_default_upload_course_image',\n            args: args,\n            done: _uploadDone,\n            fail: notification.exception\n        };\n\n        // initiate ajax call\n        ajax.call([ajaxCall]);\n    };\n\n    /**\n     * Handles theme_urcourses_default_upload_course_image response data.\n     * @param {Object} response\n     */\n    var _uploadDone = function() {\n        // unset image data\n        _setImageData('');\n        _setImageName('');\n\n        // remove confirm/cancel buttons\n        _root.removeClass('confirm');\n\n        // unset course original image data\n        $(SELECTORS.HEADER).data('original_image', '');\n\n        // clear file input\n        $(SELECTORS.UPLOADER).val('');\n\n        str.get_string('success:courseimageuploaded', 'theme_urcourses_default')\n            .done(_createSuccessPopup);\n    };\n\n    /**\n     * Unsets _imagedata, resets course header image, removes confirm/cancel buttons.\n     */\n    var _cancelUpload = function() {\n        // unset image data\n        _setImageData('');\n        _setImageName('');\n\n        // reset header image\n        var original_img = $(SELECTORS.HEADER).data('original_img');\n        $(SELECTORS.SQUARE_IMG).css({'background-image': original_img});\n        $(SELECTORS.HEADER).css({'background-image': original_img});\n\n        // clear file input\n        $(SELECTORS.UPLOADER).val('');\n\n        // hide save/cancel buttons\n        _root.removeClass('confirm');\n\n        // unset course original image data\n        $(SELECTORS.HEADER).data('original_image', '');\n    };\n\n    /**\n     * Creates a bootstrap dismissable containing error text.\n     * Dismissable should appear in header and should cover upload button.\n     * @param {string} text Error text\n     */\n    var _createErrorPopup = function(text) {\n        // create bootstrap 4 dismissable\n        var popup = $('<div></div>');\n        popup.text(text);\n        popup.css({'position' : 'absolute'});\n        popup.css({'left' : '5px'});\n        popup.css({'bottom' : '30px'});\n        popup.addClass('alert alert-danger alert-dismissable fade show');\n\n        // create dismiss button\n        var dismissBtn = $('<button></button>');\n        dismissBtn.html('&times;');\n        dismissBtn.addClass('close');\n        dismissBtn.attr('type', 'button');\n        dismissBtn.attr('data-dismiss', 'alert');\n\n        // append dismiss button to popup\n        popup.append(dismissBtn);\n\n        // add to header's course image area\n        $(SELECTORS.HEADER_TOP).append(popup);\n    };\n\n    /**\n     * Creates a bootstrap dismissable containing success text.\n     * Dismissable should appear in header and should cover upload button.\n     * @param {string} text Success text.\n     */\n    var _createSuccessPopup = function(text) {\n        // create bootstrap 4 dismissable\n        var popup = $('<div></div>');\n        popup.text(text);\n        popup.prop('id','cimage_success_popup');\n        popup.css({'position' : 'absolute'});\n        popup.css({'left' : '5px'});\n        popup.css({'bottom' : '30px'});\n        popup.addClass('alert alert-success alert-dismissable fade show');\n\n        // create dismiss button\n        var dismissBtn = $('<button></button>');\n        dismissBtn.html('&times;');\n        dismissBtn.addClass('close');\n        dismissBtn.attr('type', 'button');\n        dismissBtn.attr('data-dismiss', 'alert');\n\n        // append dismiss button to popup\n        popup.append(dismissBtn);\n\n        // add to header's course image area\n        $(SELECTORS.HEADER_TOP).append(popup);\n\n        // makes the alert disapear after a set amout of time.\n        setTimeout(function() {\n            $('#cimage_success_popup').fadeTo(500, 0).slideUp(500, function(){\n                 $(this).remove();\n            });\n        },1800);\n    };\n\n    /**\n     * Taken from theme_snap.\n     * Get human file size from bytes.\n     * https://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable.\n     * @param {int} size\n     * @returns {string}\n     */\n    var _humanFileSize = function(size) {\n        var i = Math.floor(Math.log(size) / Math.log(1024));\n        return (size / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B', 'KB', 'MB', 'GB', 'TB'][i];\n    };\n\n    /**\n     * Entry point to module. Sets globals and registers event listeners.\n     * @param {String} root Jquery selector for container.\n     * @return void\n     */\n    var init = function(root, maxbytes, courseid) {\n        _setGlobals(root, maxbytes, courseid);\n        _registerEventListeners();\n    };\n\n    return {\n        init: init\n    };\n});"],"file":"course_image_uploader.min.js"}