function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}define("theme_urcourses_default/course_enrolment",["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","theme_urcourses_default/course_actions"],(function($,ajax,notification,str,ModalFactory,ModalEvents,courseActionsLib){var _root,_course,_element,_semester,_currentsem,_semesterdates,_categories,_templatelist,_homeurl,fn,_ref,SELECTORS_BTN_ENROLTERM=".btn_enrolterm",SELECTORS_STARTHOLDER="#course_tools_startholder",SELECTORS_ENDHOLDER="#course_tools_endholder",SELECTORS_STARTDAY="#course_tools_start_day",SELECTORS_STARTMONTH="#course_tools_start_month",SELECTORS_STARTYEAR="#course_tools_start_year",SELECTORS_STARTHOUR="#course_tools_start_hour",SELECTORS_STARTMINUTE="#course_tools_start_minute",SELECTORS_ENDDAY="#course_tools_end_day",SELECTORS_ENDMONTH="#course_tools_end_month",SELECTORS_ENDYEAR="#course_tools_end_year",SELECTORS_ENDHOUR="#course_tools_end_hour",SELECTORS_ENDMINUTE="#course_tools_end_minute",SELECTORS_ENDENABLE="#course_tools_enddate_enabled",SELECTORS_ERR_START="#error_course_tools_start",SELECTORS_ERR_END="#error_course_tools_end",TEMPLATES_MODAL_COURSE_ACTION_CONTENT="theme_urcourses_default/modal_course_action_date",_setActiveTemplate=function(e){e.hasClass("active")?(e.removeClass("active"),e.find(".fa-check-square-o").addClass("fa-square-o"),e.find(".fa-square-o").removeClass("fa-check-square-o")):(e.addClass("active"),e.find(".fa-square-o").addClass("fa-check-square-o"),e.find(".fa-check-square-o").removeClass("fa-square-o"))},_getEnrolInfo=function(){if(_element=$(this),_semester=_element.attr("id"),_course.id){var ajaxCall={methodname:"theme_urcourses_default_header_enrollment_info",args:{courseid:_course.id,semester:_semester}};ajax.call([ajaxCall])[0].done((function(response){_populateModal(response)}))}},_populateModal=function(data){var modaltitle="Modify enrolment for "+data.semester,activatedlist="",activatedtitle="",isavailable=data.isavaliable;templatelist='<div class="form-control-feedback invalid-feedback" id="error_course_tools_section"></div> <div data-role="templateholder" class = "list-group" >',0!=data.courseinfo.length?($.each(data.courseinfo,(function(key,value){templatelist+='<div data-role = "bannerselect" class="tmpl-label  list-group-item list-group-item-action " id = '+value.crn+'><h6><i class="fa fa-square-o" aria-hidden="true"></i>  '+value.subject+" "+value.course+"-"+value.section+" ("+value.crn+")</h6></div>"})),templatelist+='<br><div class="form-check ml-3"><input class="form-check-input" type="checkbox" value="" id="course_tools_groups"><label class="form-check-label" for="course_tools_groups"><h6> Create groups for each section </h6> </label> </div>'):templatelist+='<div data-role = "templateselect" class="tmpl-label list-group-item list-group-item-action" id = "0" ><p>There are no additional sections available at this time </p></div>',0!=data.activated.length&&(activatedtitle='<label class="col-form-label d-inline"><b> Current enrolments:  </b></label></br>',activatedlist+='<div class="list-group">',$.each(data.activated,(function(key,value){var linkedClass="alert-warning";value.linked&&(linkedClass="alert-success"),1!=value.linked?activatedlist+='<div data-role="delete_button" data-fullname ="'+value.fullname+'" id="delete_'+value.crn+"_"+value.urid+'" class="list-group-item list-group-item-secondary enrollment-delete '+linkedClass+' "><h6 class ="ml-3 d-inline">'+value.subject+" "+value.course+"-"+value.section+" ("+value.crn+')<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></h6></div>':activatedlist+='<div data-fullname ="'+value.fullname+'" id="delete_'+value.crn+"_"+value.urid+'" class="list-group-item list-group-item-secondary enrollment-delete '+linkedClass+' "><h6 class ="ml-3 d-inline">'+value.subject+" "+value.course+"-"+value.section+" ("+value.crn+")</h6></div>"})),activatedlist+="</div><br>"),templatelist+="</div>";var pastSemester=!1;if(_semester<_currentsem&&(pastSemester=!0),pastSemester){modaltitle="Modify enrolment";var templatelist='<div data-role = "templateselect" class="tmpl-label list-group-item list-group-item-action" id = "0" ><p>This is a past semester. Enrolment can not be modified. </p></div><br>';0!=data.activated.length&&(activatedlist="",activatedlist+='<div class="list-group">',$.each(data.activated,(function(key,value){var linkedClass="alert-warning";value.linked&&(linkedClass="alert-success"),activatedlist+='<div class="list-group-item list-group-item-secondary '+linkedClass+' "><h6 class ="ml-3 d-inline">'+value.subject+" "+value.course+"-"+value.section+"</h6></div>"})),activatedlist+="</div><br>"),ModalFactory.create({type:ModalFactory.types.CANCEL,title:modaltitle,body:templatelist+activatedtitle+activatedlist}).then((function(modal){modal.footer.prepend('<a type="button" class="btn btn-primary justify-content-start mr-auto p-2" href="'+_homeurl+"/blocks/urcourserequest?semester="+_semester+'">My enrolment overview</a>'),modal.show()}))}else ModalFactory.create({type:0!=data.courseinfo.length?ModalFactory.types.SAVE_CANCEL:ModalFactory.types.CANCEL,title:modaltitle,body:isavailable?'<label class="col-form-label d-inline"><b> Available enrolments:  </b></label></br>'+templatelist+"</br>"+activatedtitle+activatedlist:""}).then((function(modal){var root;(modal.footer.prepend('<a type="button" class="btn btn-primary justify-content-start mr-auto p-2" href="'+_homeurl+"/blocks/urcourserequest?semester="+_semester+'">My enrolment overview</a>'),isavailable&&0!=data.courseinfo.length)?(modal.setSaveButtonText("Save"),(root=modal.getRoot()).on(ModalEvents.cancel,(function(){})),root.on(ModalEvents.save,(function(e){var templateHolder=$('div[data-role="templateholder"'),selectedTemplates=$(templateHolder).find(".active");if(selectedTemplates.length<=0)e.preventDefault(),$("#error_course_tools_section").text("Please select a section"),$("#error_course_tools_section").attr("display","block"),$("#error_course_tools_section").show();else{for(var templateids=[],i=0;i<selectedTemplates.length;i++)templateids.push({crn:$(selectedTemplates[i]).attr("id")});var groupcheck=$("#course_tools_groups").prop("checked");_addEnrolmentDateConfirm(data,templateids,groupcheck)}}))):(root=modal.getRoot()).on(ModalEvents.cancel,(function(){}));root.on(ModalEvents.hidden,(function(){$("div[data-role='templateholder']").remove()})),modal.show()})).done((function(){isavailable&&(data.courseinfo.length>0?$(".tmpl-label").bind("click",(function(){_setActiveTemplate($(this))})):$('button[data-action="cancel"]').text("Close")),0!=data.activated.length&&$('div[data-role="delete_button"]').bind("click",(function(){_deleteConfirmation($(this))}))}))},_addEnrolmentDateConfirm=(fn=regeneratorRuntime.mark((function _callee(data,templateids,groupcheck){var nextyear,newstart,newend,formatednewstart,startdate,enddate,modaltitle,template;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(nextyear=(new Date).getFullYear()+1,newstart=(new Date).getMonth()+" "+(new Date).getDate()+", "+(new Date).getFullYear(),newend=(new Date).getMonth()+" "+(new Date).getDate()+", "+nextyear,formatednewstart="",$.each(_semesterdates,(function(index,item){if(index==_semester){var starttemp=item.startdate.split("-"),endtemp=item.enddate.split("-");newstart=parseInt(starttemp[1],10)+" "+starttemp[0]+", "+starttemp[2],newend=parseInt(endtemp[1],10)+" "+endtemp[0]+", "+endtemp[2];var d=new Date(starttemp[2],starttemp[1]-1,starttemp[0]);formatednewstart=d.toLocaleString("default",{month:"short"})+" "+starttemp[0]+", "+starttemp[2]}})),startdate=_course.startdate.mon+" "+_course.startdate.mday+", "+_course.startdate.year,enddate=_course.enddate.mon+" "+_course.enddate.mday+", "+_course.enddate.year,startdate!=newstart||enddate!=newend){_context.next=11;break}_addEnrolment(templateids,groupcheck,!0),_context.next=18;break;case 11:return modaltitle="Would you like to change course dates?",_context.next=14,self.render(TEMPLATES_MODAL_COURSE_ACTION_CONTENT);case 14:template=_context.sent,startdate=_course.startdate.month+" "+_course.startdate.mday+", "+_course.startdate.year,enddate=_course.enddate.month+" "+_course.enddate.mday+", "+_course.enddate.year,ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:modaltitle,body:"<p><b>Current Course Dates:<br/></b><div class='alert alert-warning' role='alert'>"+(_course.enddate.year<_course.startdate.year?"Start Date: "+startdate+"<br> End Date: No endate set":startdate+" until "+enddate)+"</div>"+(""==formatednewstart?"":"The "+data.semester+" term will begin "+formatednewstart+"<br/><br/>")+template,backdrop:"static",keyboard:!1,dismissible:!1}).then((function(modal){modal.setSaveButtonText("Update");var root=modal.getRoot();root.on(ModalEvents.cancel,(function(){_addEnrolment(templateids,groupcheck,!0)})),root.on(ModalEvents.save,(function(e){validate()?_addEnrolment(templateids,groupcheck,!1):e.preventDefault()})),modal.show();var modaltemp=modal.modal;$(modaltemp).find(".close").attr("id","closemodal"),$("#closemodal").bind("click",(function(){_closeDateConfirm($(this),modal)})),$(modaltemp).find(".close").addClass("dateconfirm"),$(root).click((function(e){$(e.target).is("button")||$(e.target).parent().is("button")?($(SELECTORS_ENDHOLDER).remove(),$(SELECTORS_STARTHOLDER).remove(),$(SELECTORS_ERR_START).remove(),$(SELECTORS_ERR_END).remove(),modal.hide()):(e.preventDefault(),modal.show())}))})).done((function(){var startdatefill={year:(new Date).getFullYear(),mon:(new Date).getMonth(),mday:(new Date).getDate()},enddatefill={year:(new Date).getFullYear()+1,mon:(new Date).getMonth(),mday:(new Date).getDate()};$.each(_semesterdates,(function(index,item){if(index==_semester){var starttemp=item.startdate.split("-"),endtemp=item.enddate.split("-");startdatefill={year:starttemp[2],mon:starttemp[1],mday:starttemp[0]},enddatefill={year:endtemp[2],mon:endtemp[1],mday:endtemp[0]}}})),$('button[data-action="cancel"]').text("Continue without updating"),courseActionsLib.populateDateSelects(startdatefill,enddatefill),courseActionsLib.registerDateEventListeners(_element)}));case 18:case"end":return _context.stop()}}),_callee)})),_ref=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(_x,_x2,_x3){return _ref.apply(this,arguments)}),_closeDateConfirm=function(e,modal){$(SELECTORS_ENDHOLDER).remove(),$(SELECTORS_STARTHOLDER).remove(),$(SELECTORS_ERR_START).remove(),$(SELECTORS_ERR_END).remove(),modal.hide()},validate=function(){var startday=$(SELECTORS_STARTDAY).val(),startmonth=$(SELECTORS_STARTMONTH).val(),startyear=$(SELECTORS_STARTYEAR).val(),endyear=$(SELECTORS_ENDYEAR).val(),endday=$(SELECTORS_ENDDAY).val(),endmonth=$(SELECTORS_ENDMONTH).val(),test=!0,startdate=new Date(startyear+"."+startmonth+"."+startday).getTime()/1e3;return new Date(endyear+"."+endmonth+"."+endday).getTime()/1e3<startdate&&$(SELECTORS_ENDENABLE).is(":checked")?($(SELECTORS_ERR_START).text("Course end date can not be before start date"),$(SELECTORS_ERR_START).attr("display","block"),$(SELECTORS_ERR_START).show(),test=!1):($(SELECTORS_ERR_START).text(""),$(SELECTORS_ERR_END).text("")),test},_addEnrolment=function(templateids,groupcheck,isoriginal){if(_course.id){if(isoriginal)var startdate=_course.startdate.mday+"-"+_course.startdate.mon+"-"+_course.startdate.year+"-"+_course.startdate.hours+"-"+_course.startdate.minutes,enddate=_course.enddate.mday+"-"+_course.enddate.mon+"-"+_course.enddate.year+"-"+_course.enddate.hours+"-"+_course.enddate.minutes;else{startdate=$(SELECTORS_STARTDAY).val()+"-"+$(SELECTORS_STARTMONTH).val()+"-"+$(SELECTORS_STARTYEAR).val()+"-"+$(SELECTORS_STARTHOUR).val()+"-"+$(SELECTORS_STARTMINUTE).val(),enddate="0";if($(SELECTORS_ENDENABLE).is(":checked"))enddate=$(SELECTORS_ENDDAY).val()+"-"+$(SELECTORS_ENDMONTH).val()+"-"+$(SELECTORS_ENDYEAR).val()+"-"+$(SELECTORS_ENDHOUR).val()+"-"+$(SELECTORS_ENDMINUTE).val()}groupcheck=""==groupcheck||0==groupcheck?0:1;var ajaxCall={methodname:"theme_urcourses_default_header_activate_course",args:{courseid:_course.id,semester:_semester,crns:templateids,groupcheck:groupcheck,startdate:startdate,enddate:enddate,isoriginal:isoriginal},fail:notification.exception};ajax.call([ajaxCall])[0].done((function(response){var title="ERROR:",info='<div class="alert alert-warning" role="alert">'+response.result+"<br></div>";""!=response.value&&(title="Enrolment assigned successfully",info='<div class="alert alert-success" role="alert">'+response.result+"<br></div>"),ModalFactory.create({type:ModalFactory.types.CANCEL,title:title,body:info}).then((function(modal){modal.show();var root=modal.getRoot();$('button[data-action="cancel"]').text("Close"),root.on(ModalEvents.hidden,(function(){location.reload()}))}))}))}},_deleteConfirmation=function(element){var fullname=element.data("fullname");ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:"Delete Enrolment",body:"<p><b>Are you sure you want to delete enrolment for "+fullname+"?</b><br />"}).then((function(modal){modal.setSaveButtonText("Delete");var root=modal.getRoot();root.on(ModalEvents.cancel,(function(){})),root.on(ModalEvents.save,(function(){_deleteEnrollment(element)})),modal.show()}))},_deleteEnrollment=function(e){var crn=e.attr("id").split("_"),ajaxCall={methodname:"theme_urcourses_default_header_delete_enrollment",args:{courseid:crn[2],semester:_semester,crn:crn[1]},fail:notification.exception};ajax.call([ajaxCall])[0].done((function(response){$('button[data-action="cancel"] ').trigger("click");var title="ERROR:",info='<div class="alert alert-warning" role="alert">'+response.result+"<br></div>";""!=response.result&&(title="Successfully Removed Enrolment",info='<div class="alert alert-success" role="alert">'+response.result+"<br></div>"),ModalFactory.create({type:ModalFactory.types.CANCEL,title:title,body:info}).then((function(modal){modal.show(),modal.getRoot().on(ModalEvents.hidden,(function(){location.reload()})),$('button[data-action="cancel"]').text("Close")}))}))},_semesterDateObject=function(item){var temp=item.split("-");return new Date(temp[2]+"-"+temp[1]+"-"+temp[0])};return{init:function(root,course,semesterdates,categories,templatelist,homeurl){var currentsem=function(semesterdates){var current=new Date,cterm="";return $.each(semesterdates,(function(index,item){var start=_semesterDateObject(item.startdate),end=_semesterDateObject(item.enddate);if(current>=start&&current<=end)return cterm=index,index})),cterm}(semesterdates);!function(root,course,semesterdates,categories,templatelist,homeurl,currentsem){_root=$(root),_semesterdates=semesterdates,_currentsem=currentsem,_categories=categories,_templatelist=templatelist,_homeurl=homeurl,courseActionsLib=new courseActionsLib((_course=course).id,_course.coursename,_course.shortname,_course.startdate,_course.enddate,_templatelist,_categories)}(root,course,semesterdates,categories,templatelist,homeurl,currentsem),_root.on("click",SELECTORS_BTN_ENROLTERM,_getEnrolInfo)}}}));

//# sourceMappingURL=course_enrolment.min.js.map