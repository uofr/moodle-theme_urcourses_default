function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("theme_urcourses_default/modal_help",["exports","jquery","core/notification","core/templates","core/custom_interaction_events","core/key_codes","core/modal","core/modal_events","core/modal_registry","theme_urcourses_default/modal_help_ajax","theme_urcourses_default/fuzzysearch"],(function(_exports,_jquery,_notification,_templates,_custom_interaction_events,_key_codes,_modal,_modal_events,_modal_registry,_modal_help_ajax,_fuzzysearch){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||_unsupportedIterableToArray(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events),_key_codes=_interopRequireDefault(_key_codes),_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_registry=_interopRequireDefault(_modal_registry),_modal_help_ajax=_interopRequireDefault(_modal_help_ajax),_fuzzysearch=_interopRequireDefault(_fuzzysearch);var SELECTORS_SEARCH="#modal_help_search",SELECTORS_SEARCH_BUTTON="#modal_help_search_btn",SELECTORS_SEARCH_CLEAR="#modal_help_search_clear",SELECTORS_SUGGESTIONS="#modal_help_search_suggestions",SELECTORS_SUGGESTION_ITEM=".modal-help-suggestion-item",SELECTORS_SEARCH_RESULT=".modal-help-search-result",SELECTORS_BREADCRUMB=".breadcrumb-item a",SELECTORS_GUIDE_PAGE_LINK='[data-region="guide-page-content"] a',SELECTORS_OVERLAY_LOADING=".overlay-icon-container",SELECTORS_BACK='[data-action="go-back"]',SELECTORS_BACK_TO_TOP="#modal-help-back-to-top",SELECTORS_MAIN='[data-region="modal-help-main"]',TEMPLATES_MODAL_HELP_GUIDE_PAGE="theme_urcourses_default/modal_help_guide_page",TEMPLATES_MODAL_HELP_SEARCH_RESULTS="theme_urcourses_default/modal_help_search_results",TEMPLATES_MODAL_HELP_LINKS_PAGE="theme_urcourses_default/modal_help_links",TEMPLATES_OVERLAY_LOADING="core/overlay_loading",ModalHelp=function(_Modal){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(ModalHelp,_Modal);var Constructor,protoProps,staticProps,_getJsonData,_renderGuidePage,_searchGuides,_getTopicList,_init,_super=_createSuper(ModalHelp);function ModalHelp(root){var _this;return function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ModalHelp),(_this=_super.call(this,root)).contextId=null,_this.topicList=null,_this.topicTitles=null,_this.searchBox=_this.modal.find(SELECTORS_SEARCH),_this.searchButton=_this.modal.find(SELECTORS_SEARCH_BUTTON),_this.searchClear=_this.modal.find(SELECTORS_SEARCH_CLEAR),_this.suggestionBox=_this.modal.find(SELECTORS_SUGGESTIONS),_this.content=_this.modal.find(SELECTORS_MAIN),_this.suggestionItemIndex=0,_this.currentPath="",_this.history=[],_this.landingPageUrl="",_this.userIsInstructor=null,_this}return Constructor=ModalHelp,protoProps=[{key:"init",value:(_init=_asyncToGenerator(regeneratorRuntime.mark((function _callee(contextId,localUrl){var _yield$Promise$all,_yield$Promise$all2;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.prev=0,this.contextId=contextId,_context.next=4,Promise.all([this.getTopicList(),_modal_help_ajax.default.getLandingPageUrl(this.contextId,localUrl),_modal_help_ajax.default.userIsInstructor()]);case 4:_yield$Promise$all=_context.sent,_yield$Promise$all2=_slicedToArray(_yield$Promise$all,3),this.topicList=_yield$Promise$all2[0],this.landingPageUrl=_yield$Promise$all2[1],this.userIsInstructor=_yield$Promise$all2[2],this.topicTitles=this.topicList.map((function(topic){return topic.title})),_fuzzysearch.default.setDictionary(this.topicTitles),this.initEvents(),_context.next=17;break;case 14:_context.prev=14,_context.t0=_context.catch(0),_notification.default.exception(_context.t0);case 17:case"end":return _context.stop()}}),_callee,this,[[0,14]])}))),function(_x,_x2){return _init.apply(this,arguments)})},{key:"initEvents",value:function(){var _this2=this;this.searchBox.on("input",(function(){_this2.searchBox.val()?_this2.showSearchClear():_this2.hideSearchClear(),_this2.updateSuggestions()})),this.searchBox.on("focus",(function(){_this2.updateSuggestions()})),this.searchClear.on("click",(function(){_this2.clearSearch()})),this.getRoot().on("click",(function(e){e.target!==_this2.searchBox[0]&&e.target!==_this2.suggestionBox[0]&&_this2.hideSuggestionBox()})),this.searchBox.on("keydown",(function(e){e.keyCode===_key_codes.default.arrowUp||e.keyCode===_key_codes.default.arrowLeft?(e.preventDefault(),_this2.suggestionItemIndex=_this2.getSuggestionItems().length-0,_this2.getSuggestionItems().eq(_this2.suggestionItemIndex).focus()):e.keyCode!==_key_codes.default.arrowDown&&e.keyCode!==_key_codes.default.arrowRight||(e.preventDefault(),_this2.suggestionItemIndex=-1,_this2.getSuggestionItems().eq(_this2.suggestionItemIndex).focus())})),this.suggestionBox.on("keydown",SELECTORS_SUGGESTION_ITEM,(function(e){e.keyCode===_key_codes.default.arrowUp||e.keyCode===_key_codes.default.arrowLeft?(e.preventDefault(),_this2.suggestionItemIndex--,_this2.suggestionItemIndex<-1&&(_this2.suggestionItemIndex=_this2.getSuggestionItems().length-0),_this2.getSuggestionItems().eq(_this2.suggestionItemIndex).focus()):e.keyCode!==_key_codes.default.arrowDown&&e.keyCode!==_key_codes.default.arrowRight||(e.preventDefault(),_this2.suggestionItemIndex++,_this2.suggestionItemIndex>=_this2.getSuggestionItems().length&&(_this2.suggestionItemIndex=-1),_this2.getSuggestionItems().eq(_this2.suggestionItemIndex).focus())})),this.getRoot().on(_modal_events.default.shown,(function(){_this2.renderGuidePage(_this2.landingPageUrl.url,_this2.landingPageUrl.target)})),this.getRoot().on(_modal_events.default.hidden,(function(){_this2.resetModal()})),this.suggestionBox.on(_custom_interaction_events.default.events.activate,SELECTORS_SUGGESTION_ITEM,(function(e){var topicTitle=(0,_jquery.default)(e.target).attr("data-value"),topicTitleLower=topicTitle.toLowerCase().replace(/&/g,"&amp;"),topic=_this2.topicList.find((function(topic){return topic.title.toLowerCase()===topicTitleLower})),url="".concat(topic.url,".json");_this2.searchBox.val(topicTitle),_this2.showSearchClear(),_this2.renderGuidePage(url)})),this.searchButton.on("click",(function(){var query=_this2.searchBox.val();_this2.searchGuides(query),_this2.hideSuggestionBox()})),this.searchBox.on("keydown",(function(e){if(e.keyCode===_key_codes.default.enter){var query=_this2.searchBox.val();_this2.searchGuides(query),_this2.getModal().focus(),_this2.hideSuggestionBox()}})),this.getModal().on(_custom_interaction_events.default.events.activate,SELECTORS_SEARCH_RESULT,(function(e){var url=(0,_jquery.default)(e.target).attr("data-url");_this2.renderGuidePage("".concat(url,".json"))})),this.getRoot().on("click",SELECTORS_GUIDE_PAGE_LINK,(function(e){var href=(0,_jquery.default)(e.currentTarget).attr("href");if(!href.startsWith("#"))if(href.endsWith("/")&&(href=href.substring(0,href.lastIndexOf("/"))),e.preventDefault(),href.startsWith("http")||href.startsWith("https")||href.startsWith("mailto"))window.open(href,"_blank");else{var _step,_href$split2=_slicedToArray(href.split("#"),2),path=_href$split2[0],target=_href$split2[1],hrefPath=path.split("/"),actualPath=_this2.currentPath.split("/"),_iterator=function(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e2){throw _e2},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e3){didErr=!0,err=_e3},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}(hrefPath);try{for(_iterator.s();!(_step=_iterator.n()).done;){var node=_step.value;".."===node?actualPath.pop():"."!==node&&actualPath.push(node)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var url=actualPath.join("/");_this2.renderGuidePage("".concat(url,".json"),target)}})),this.getModal().on("click",SELECTORS_BREADCRUMB,(function(e){e.preventDefault();var breadcrumb=(0,_jquery.default)(e.currentTarget),url=breadcrumb.attr("href"),target=breadcrumb.attr("data-target");_this2.renderGuidePage(url,target)})),this.getModal().on("click",SELECTORS_BACK,(function(e){if(e.preventDefault(),_this2.history.length>1){_this2.history.pop();var _this2$history$pop2=_slicedToArray(_this2.history.pop(),2),url=_this2$history$pop2[0],target=_this2$history$pop2[1];_this2.renderGuidePage(url,target)}})),(0,_jquery.default)(this.getModal()).find(".modal-body").scroll((function(){(0,_jquery.default)(this).scrollTop()>50?(0,_jquery.default)(SELECTORS_BACK_TO_TOP).fadeIn():(0,_jquery.default)(SELECTORS_BACK_TO_TOP).fadeOut()})),this.getModal().on("click",SELECTORS_BACK_TO_TOP,(function(e){return(0,_jquery.default)(_this2.getModal()).find(".modal-body").animate({scrollTop:0},400),!1}))}},{key:"getTopicList",value:(_getTopicList=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var _yield$ModalHelpAjax$,instructor,url,topicListJson,topics,topicsSorted,prefix;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,_modal_help_ajax.default.getTopicListUrl(this.contextId);case 2:return _yield$ModalHelpAjax$=_context2.sent,instructor=_yield$ModalHelpAjax$.instructor,url=_yield$ModalHelpAjax$.url,_context2.next=7,this.getJsonData(url);case 7:return topicListJson=_context2.sent,topics=topicListJson.jsondata.page_data[0].all_pages,topicsSorted=topics.sort((function(a,b){return a.title>b.title})),prefix=instructor?"Instructor":"Students",_context2.abrupt("return",topicsSorted.filter((function(topic){return topic.prefix===prefix})));case 12:case"end":return _context2.stop()}}),_callee2,this)}))),function(){return _getTopicList.apply(this,arguments)})},{key:"updateSuggestions",value:function(){var query=this.searchBox.val(),suggestions=_fuzzysearch.default.search(query);suggestions.length||(suggestions=this.topicTitles);var suggestionList=this.getSuggestions(suggestions);this.suggestionBox.html(""),this.suggestionBox.append(suggestionList),this.showSuggestionBox()}},{key:"getSuggestions",value:function(suggestions){return suggestions.map((function(suggestion){return'<a href="#" class="modal-help-suggestion-item"\n                                              data-value="'.concat(suggestion,'">').concat(suggestion,"</a>")}))}},{key:"searchGuides",value:(_searchGuides=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(query){var searchUrl,basePath,baseUrl,searchResults,breadcrumbs;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(query){_context3.next=2;break}return _context3.abrupt("return");case 2:return _context3.prev=2,_context3.next=5,this.setLoading(!0);case 5:return _context3.next=7,_modal_help_ajax.default.getSearchUrl(this.contextId,query);case 7:return searchUrl=_context3.sent,(basePath=searchUrl.split("/")).pop(),basePath.pop(),baseUrl=basePath.join("/"),_context3.next=14,this.getJsonData(searchUrl);case 14:return searchResults=_context3.sent,breadcrumbs=[{active:!1,name:this.userIsInstructor?"Instructor Guide":"Student Guides",url:this.userIsInstructor?"".concat(baseUrl,"/instructor.json"):"".concat(baseUrl,"/student.json"),target:""},{active:!0,name:"Search Results: ".concat(query),url:"",target:""}],_context3.next=18,this.renderReplace(TEMPLATES_MODAL_HELP_SEARCH_RESULTS,{results:searchResults.jsondata,query:query,breadcrumbs:breadcrumbs},this.content);case 18:this.getBody()[0].scrollTop=0,this.history.push([searchUrl]),_context3.next=25;break;case 22:_context3.prev=22,_context3.t0=_context3.catch(2),_notification.default.exception(_context3.t0);case 25:return _context3.prev=25,this.setLoading(!1),_context3.finish(25);case 28:case"end":return _context3.stop()}}),_callee3,this,[[2,22,25,28]])}))),function(_x3){return _searchGuides.apply(this,arguments)})},{key:"renderGuidePage",value:(_renderGuidePage=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(url){var target,page,breadcrumbs,content,frontmatter,jsondata,_ref,title,path,breadcrumbUrl,breadcrumbPage,_frontmatter,_jsondata,_ref2,_title,guidesBase,html,back,anchor,_args4=arguments;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return target=_args4.length>1&&void 0!==_args4[1]?_args4[1]:"",_context4.prev=1,_context4.next=4,this.setLoading(!0);case 4:return _context4.next=6,this.getJsonData(url);case 6:page=_context4.sent,breadcrumbs=[],content=page.content,frontmatter=page.frontmatter,jsondata=page.jsondata,_ref=frontmatter||jsondata.page_data[0],title=_ref.title,path=url.split("/"),breadcrumbs.unshift({active:!0,name:title,target:target,url:url}),path.pop();case 13:if("guides"===path[path.length-1]){_context4.next=24;break}return breadcrumbUrl="".concat(path.join("/"),".json"),_context4.next=17,this.getJsonData(breadcrumbUrl);case 17:breadcrumbPage=_context4.sent,_frontmatter=breadcrumbPage.frontmatter,_jsondata=breadcrumbPage.jsondata,_ref2=_frontmatter||_jsondata.page_data[0],_title=_ref2.title,breadcrumbs.unshift({active:!1,name:_title,url:breadcrumbUrl}),path.pop(),_context4.next=13;break;case 24:if(guidesBase=path.join("/"),this.userIsInstructor&&"Instructor Guide"!==breadcrumbs[0].name&&breadcrumbs.unshift({active:!1,name:"Instructor Guide",url:"".concat(guidesBase,"/instructor.json")}),this.userIsInstructor||"Student Guides"===breadcrumbs[0].name||breadcrumbs.unshift({active:!1,name:"Student Guides",url:"".concat(guidesBase,"/student.json")}),html=(html=(html=(html=content||jsondata.page_data[0].content).replaceAll('src="assets','src="'.concat(guidesBase,"/assets"))).replaceAll('src="../assets','src="'.concat(guidesBase,"/assets"))).replaceAll('src="./images','src="'.concat(guidesBase,"/images")),back=!1,this.history.length>0&&(back=!0),(0,_jquery.default)(this.header).find(".modal-help-links").length){_context4.next=36;break}return _context4.next=36,this.renderAppend(TEMPLATES_MODAL_HELP_LINKS_PAGE,{isinstructor:this.userIsInstructor},(0,_jquery.default)(this.header).find(".modal-help-header"));case 36:return _context4.next=38,this.renderReplace(TEMPLATES_MODAL_HELP_GUIDE_PAGE,{html:html,breadcrumbs:breadcrumbs,isinstructor:this.userIsInstructor,back:back},this.content);case 38:this.currentPath=url.substring(0,url.lastIndexOf("/")),target?(anchor=target.startsWith("#")?(0,_jquery.default)(target):(0,_jquery.default)("#".concat(target))).length&&anchor[0].scrollIntoView():this.getBody()[0].scrollTop=0,this.history.push([url,target]),_context4.next=46;break;case 43:_context4.prev=43,_context4.t0=_context4.catch(1),_notification.default.exception(_context4.t0);case 46:return _context4.prev=46,this.setLoading(!1),_context4.finish(46);case 49:case"end":return _context4.stop()}}),_callee4,this,[[1,43,46,49]])}))),function(_x4){return _renderGuidePage.apply(this,arguments)})},{key:"getJsonData",value:(_getJsonData=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(url){var response;return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return _context5.next=2,fetch(url);case 2:return response=_context5.sent,_context5.abrupt("return",response.json());case 4:case"end":return _context5.stop()}}),_callee5)}))),function(_x5){return _getJsonData.apply(this,arguments)})},{key:"setLoading",value:function(loading){if(loading)return this.renderAppend(TEMPLATES_OVERLAY_LOADING,{visible:!0},this.content);this.getBody().find(SELECTORS_OVERLAY_LOADING).remove()}},{key:"renderReplace",value:function(template,data,area){return _templates.default.render(template,data).then((function(html,js){return _templates.default.replaceNodeContents(area,html,js)}))}},{key:"renderAppend",value:function(template,data,area){return _templates.default.render(template,data).then((function(html,js){return _templates.default.appendNodeContents(area,html,js)}))}},{key:"resetModal",value:function(){this.content.html(""),this.searchBox.val(""),this.suggestionBox.html("")}},{key:"clearSearch",value:function(){this.searchBox.val(""),this.hideSearchClear()}},{key:"showSuggestionBox",value:function(){this.suggestionBox.removeClass("d-none"),this.suggestionBox[0].scrollTop=0}},{key:"hideSuggestionBox",value:function(){this.suggestionBox.addClass("d-none")}},{key:"showSearchClear",value:function(){this.searchClear.removeClass("d-none")}},{key:"hideSearchClear",value:function(){this.searchClear.addClass("d-none")}},{key:"getSuggestionItems",value:function(){return this.suggestionBox.find(SELECTORS_SUGGESTION_ITEM)}}],staticProps=[{key:"getType",value:function(){return"theme_urcourses_default-help"}}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),ModalHelp}(_modal.default);_exports.default=ModalHelp;var registered=!1;return registered||(_modal_registry.default.register(ModalHelp.getType(),ModalHelp,"theme_urcourses_default/modal_help"),registered=!0),_exports.default}));

//# sourceMappingURL=modal_help.min.js.map