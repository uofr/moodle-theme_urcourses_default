{"version":3,"file":"studentaccount.min.js","sources":["../src/studentaccount.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Responsible for registering all events for Course Tools including:\n * Course Creation-> calls Course Action Library to handle modals and ajax request\n * Course Duplication-> calls Course Action Library to handle modals and ajax request\n * Create Student Account-> performs ajax request to create a student account for instructor\n * Course Description Edit-> Reroutes to Course Edit page, and add marker to go right to Course Summary Section\n *\n * @package    theme_urcourses_default\n * @author     Brooke Clary\n *\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str',\n    'core/modal_factory', 'core/modal_events'],\n    function($, ajax, notification, str, ModalFactory, ModalEvents) {\n\n    /** Jquery selector strings. */\n    var BTN_STUDENT_ACCOUNT= '#action-menu-0-menu a[data-title=\"studentaccount,theme_urcourses_default\"]';\n\n    /**\n     * Sets up event listeners.\n     * @return void\n     */\n    var _registerEventListeners = function(link) {\n        $(link).on('click', _createStudentAction);\n    };\n\n     /**\n     * Modal after button click to create student account\n     */\n    var _createStudentAction =  function() {\n\n        //look if created or not\n        var info = $(BTN_STUDENT_ACCOUNT).data(\"info\");\n        var infoarray = info.split(',');\n\n        var value =infoarray[1];\n        var username =infoarray[0];\n\n        if(value){\n            //view student account info\n             getStudentAccountInfo(username);\n        }else{\n\n            var modaltitle = 'Create a test student for UR Courses';\n            var modalaction = '<b>The following test user account will be created: </b><br><br>'\n                            + '<b>Email address </b>'\n                            +'<a class=\"btn btn-link p-0\" role=\"button\" data-toggle=\"modal\" '\n                            +'data-placement=\"right\" data-target=\"moodle-email-modal-dialogue\" data-html=\"true\">'\n                                +'<i class=\"icon fa fa-question-circle text-info fa-fw \" '\n                                +'title=\"Help with test student account email\" '\n                                +'aria-label=\"Help with test student account email\"></i>'\n                            +'</a><br>'+username+'+urstudent@uregina.ca'\n                            +'<br><br><b>Username </b><br>'+username+'-urstudent'\n                            +'<hr/>'\n                            +'You can enrol this account to test and experience a course as a student.'\n                            +'<br><br>'\n                            +'<b>Would you like to create the test student account?</b>'\n                            +'<br>';\n\n            //adding in confirmation modal in case buttons accidentally clicked\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: modaltitle,\n                body: \"<p>\"+ modalaction +\"</p>\"\n            }).then(function(modal) {\n\n                modal.setSaveButtonText('Create');\n                var root = modal.getRoot();\n                root.on(ModalEvents.cancel, function(){\n                    return;\n                });\n\n                $(root).find('.fa-question-circle').parent().click(function() {\n                    ModalFactory.create({\n                        type: ModalFactory.types.CANCEL,\n                        title: \"Help with test student account email\",\n                        body:'<p>Email sent to this address will appear in your username@uregina.ca inbox</p>',\n                    }).then(function(modal) {\n                        modal.show();\n                    });\n                });\n\n                root.on(ModalEvents.save, function(e){\n                    e.preventDefault();\n                    $(root).find('button[data-action=\"save\"]').append(\n                        ' <span class=\"spinner-border spinner-border-sm\" '+\n                        'role=\"status\" aria-hidden=\"true\"></span><span class=\"sr-only\">Loading...</span>');\n\n                    _createStudentAccount(username);\n                });\n\n                modal.show();\n            });\n        }\n    };\n\n    /**\n     * After modal info has been entered call ajax request\n     */\n    var getStudentAccountInfo =  function(username) {\n\n        // set args\n        var args = {\n            username: username\n        };\n\n        // set ajax call\n        var ajaxCall = {\n            methodname: 'theme_urcourses_default_test_account_info',\n            args: args,\n            fail: notification.exception\n        };\n\n        // initiate ajax call\n        var promise =  ajax.call([ajaxCall]);\n        promise[0].done(function(data) {\n\n            var modaltitle = 'User details for test student account';\n            var info =\"\";\n            if(data.userid != 0){\n               info = '<b>Email address </b>'\n                    +'<a class=\"btn btn-link p-0\" role=\"button\" data-toggle=\"modal\" '\n                    +'data-placement=\"right\" data-target=\"moodle-email-modal-dialogue\" data-html=\"true\">'\n                    +'<i class=\"icon fa fa-question-circle text-info fa-fw \"'\n                    +' title=\"Help with test student account email\" aria-label=\"Help with test student account email\"></i>'\n                    +'</a><br>'+data.email\n                    +'<br><b>Username </b><br>'+data.username\n                    +'<br><b>Account Creation Date </b><br>'+data.datecreated+'<br/>'\n                    +'<br><div class=\"alert alert-warning d-flex justify-content-between bd-highlight \" role=\"alert\">'\n                        +'<div class=\"\">Reset test account password </div>'\n                        +'<button id=\"test_account_reset\" type=\"button\" class=\"btn btn-primary\" >Reset Password</button>'\n                    +'</div>';\n            }else{\n               info= '<div class=\"alert alert-warning\" role=\"alert\">'\n                    +' Test student account could not be found!</div>';\n            }\n\n            //adding in confirmation modal in case buttons accidentally clicked\n            ModalFactory.create({\n                type: ModalFactory.types.CANCEL,\n                title: modaltitle,\n                body:info,\n\n            }).then(function(modal) {\n                var root = modal.getRoot();\n                $(root).find('button[data-action=\"cancel\"]').text(\"Close\");\n\n                $(root).find('.fa-question-circle').parent().click(function() {\n                    ModalFactory.create({\n                        type: ModalFactory.types.CANCEL,\n                        title: \"Help with test student account email\",\n                        body:'<p>Email sent to this address will appear in your username@uregina.ca inbox</p>',\n                    }).then(function(modal) {\n                        modal.show();\n                    });\n                });\n\n                 //remove modal on hide\n                 root.on(ModalEvents.hidden, function(){\n                    //remove inputs otherwise duplicates are made causing id problems\n                    $( \"#test_account_reset\" ).remove();\n                });\n\n                modal.show();\n            }).done(function() {\n                $(\"#test_account_reset\").bind('click', function() { _resetStudentAccount($(this), username); } );\n            });\n        });\n    };\n\n     /**\n     * After modal info has been entered call ajax request\n     */\n    var _createStudentAccount = function(username) {\n\n          // set args\n          var args = {\n            username: username\n        };\n\n        // set ajax call\n        var ajaxCall = {\n            methodname: 'theme_urcourses_default_create_test_account',\n            args: args,\n            fail: notification.exception\n        };\n\n        // initiate ajax call\n        var promise = ajax.call([ajaxCall]);\n        promise[0].done(function(response) {\n            _studentAccountResponse(response);\n        });\n    };\n    /**\n     * Handles ajax return and response to return data\n     * @param {Object} response\n     */\n    var _studentAccountResponse = function(data) {\n\n        var title =\"\";\n        var info =\"\";\n        if(typeof data.unenroll != \"undefined\"){\n\n            title = \"Success: \";\n            info='<div class=\"alert alert-success\" role=\"alert\">'\n                    +data.username+\" was removed from course. </div>\";\n\n            if(!data.unenroll){\n                title = \"ERROR:\";\n                info='<div class=\"alert alert-warning\" role=\"alert\">';\n                info += data.username+\" could not be removed from course. </div>\";\n            }\n        }else if(typeof data.reset != \"undefined\"){\n            title = \"Success: \";\n            info='<div class=\"alert alert-success\" role=\"alert\">'\n                    +data.username+\" password was reset. \"+\n                    \"You will recieve an email with new credentials. \"+\n                    \"It may take a few minutes to process.</div>\";\n\n            if(!data.reset && data.userid !=0){\n                title = \"ERROR:\";\n                info='<div class=\"alert alert-warning\" role=\"alert\">';\n                info += data.username+\"'s password could not be reset, email failed to send </div>\";\n            }else if(!data.reset && data.userid ==0){\n                title = \"ERROR:\";\n                info='<div class=\"alert alert-warning\" role=\"alert\">';\n                info += data.username+\"'s account could not be found </div>\";\n            }\n        }else{\n            //create new modal\n            title = \"Success: \";\n            info='<div class=\"alert alert-success\" role=\"alert\">';\n\n            //if both actions were done\n            if(data.created != false && data.enrolled !=false){\n                info +=data.username+\" was created. \"+\n                \"New account information has been emailed to you. </div>\";\n            }else if(data.created != false && data.enrolled ==false ){\n                info += data.username+\" was created.\"+\n                \"New account information has been emailed to you. </div>\";\n            }else if(data.created == false && data.enrolled !=false ){\n                info += data.username+\".</div>\";\n            }else{\n                title = \"ERROR:\";\n                info='<div class=\"alert alert-warning\" role=\"alert\">';\n                info += data.username+\" already exists.</div>\";\n            }\n        }\n\n        //adding in confirmation modal in case buttons accidentally clicked\n        ModalFactory.create({\n            type: ModalFactory.types.CANCEL,\n            title: title,\n            body:  info\n        }).then(function(modal) {\n\n            var root = modal.getRoot();\n            $(root).find('button[data-action=\"cancel\"]').text(\"Close\");\n            root.on(ModalEvents.cancel, function(){\n                if(typeof data.reset == \"undefined\"){\n                    location.reload();\n                }\n                return;\n            });\n\n            root.find(\".close\").click(function() {\n                if(typeof data.reset == \"undefined\"){\n                    location.reload();\n                }\n                return;\n            });\n\n            modal.show();\n        });\n    };\n\n    /**\n    * After modal info has been entered call ajax request\n    */\n    var _resetStudentAccount = function(e, username) {\n\n        var modaltitle = 'Reset Password for test student account';\n        var modalaction = 'reset the password for student account '+username+'+urstudent@uregina.ca.';\n\n        //adding in confirmation modal in case buttons accidentally clicked\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: modaltitle,\n            body: \"<p><b>Do you want to \"+ modalaction +\"?</b><br /></p>\"\n        }).then(function(modal) {\n\n            modal.setSaveButtonText('Reset Password');\n            var root = modal.getRoot();\n\n            root.on(ModalEvents.cancel, function(){\n                return;\n            });\n\n            root.on(ModalEvents.save, function(e){\n\n                e.preventDefault();\n                $(root).find('button[data-action=\"save\"]').append(\n                    '<span class=\"spinner-border spinner-border-sm\"'+\n                    ' role=\"status\" aria-hidden=\"true\"></span><span class=\"sr-only\">Loading...</span>');\n\n                // set args\n                var args = {\n                    username: username\n                };\n\n                // set ajax call\n                var ajaxCall = {\n                    methodname: 'theme_urcourses_default_reset_test_account',\n                    args: args,\n                    fail: notification.exception\n                };\n\n                // initiate ajax call\n                var promise = ajax.call([ajaxCall]);\n                promise[0].done(function(response) {\n                    $(root).find('button[data-action=\"cancel\"]').click();\n                    _studentAccountResponse(response);\n                    return;\n                });\n            });\n            modal.show();\n        });\n    };\n\n    /**\n     * Entry point to module. Sets globals and registers event listeners.\n     * @param {String} root Jquery selector for container.\n     * @return void\n     */\n    var init = function() {\n\n        var salink = $(BTN_STUDENT_ACCOUNT);\n\n        salink.click(function (event) {\n            event.preventDefault();\n          });\n\n          _registerEventListeners(salink);\n    };\n\n    return {\n        init: init\n    };\n\n});"],"names":["define","$","ajax","notification","str","ModalFactory","ModalEvents","BTN_STUDENT_ACCOUNT","_createStudentAction","infoarray","data","split","value","username","getStudentAccountInfo","modalaction","create","type","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","root","getRoot","on","cancel","find","parent","click","CANCEL","show","save","e","preventDefault","append","_createStudentAccount","ajaxCall","methodname","args","fail","exception","call","done","info","userid","email","datecreated","text","hidden","remove","bind","_resetStudentAccount","this","response","_studentAccountResponse","unenroll","reset","created","enrolled","location","reload","init","salink","event"],"mappings":"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"}